name: Helm Chart Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build Helm chart for (e.g., v1.0.0)'
        required: true
        type: string
      overwrite:
        description: 'Overwrite existing chart version if it already exists'
        required: true
        type: boolean
        default: false
      skip_gh_pages:
        description: 'Skip updating gh-pages branch'
        required: false
        type: boolean
        default: false

env:
  DOCKER_REGISTRY: docker.io
  HELM_REGISTRY: ghcr.io
  IMAGE_REPOSITORY: dudizimber
  IMAGE_NAME: karo

jobs:
  helm-release:
    name: Package and Release Helm Chart
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Extract version from release
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual dispatch - use input tag
            RELEASE_TAG="${{ github.event.inputs.tag }}"
            IS_PRERELEASE="false"
            echo "Manual dispatch triggered for tag: $RELEASE_TAG"
          else
            # Automatic release - use release tag
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            IS_PRERELEASE="${{ github.event.release.prerelease }}"
            echo "Automatic release triggered for tag: $RELEASE_TAG"
          fi
          
          VERSION=${RELEASE_TAG#v}  # Remove 'v' prefix for Docker image compatibility
          
          # Use the full tag (with 'v') for Helm chart version and appVersion
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "CHART_VERSION=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "APP_VERSION=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "IS_MANUAL_DISPATCH=${{ github.event_name == 'workflow_dispatch' }}" >> $GITHUB_OUTPUT
          echo "OVERWRITE_ENABLED=${{ github.event.inputs.overwrite }}" >> $GITHUB_OUTPUT
          
          echo "Release version (no v): $VERSION"
          echo "Chart version (with v): $RELEASE_TAG" 
          echo "App version (with v): $RELEASE_TAG"
          echo "Release tag: $RELEASE_TAG"
          echo "Is prerelease: $IS_PRERELEASE"
          echo "Manual dispatch: ${{ github.event_name == 'workflow_dispatch' }}"
          echo "Overwrite enabled: ${{ github.event.inputs.overwrite }}"

      - name: Process CHANGELOG for chart
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          RELEASE_TAG="${{ steps.version.outputs.RELEASE_TAG }}"
          
          # Extract release notes from the published release
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also extract CHANGELOG section for this version if it exists
          if [[ -f "CHANGELOG.md" ]] && grep "\#\# \[${VERSION}\]" CHANGELOG.md; then
            echo "CHANGELOG_SECTION<<EOF" >> $GITHUB_OUTPUT
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG_SECTION=" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.HELM_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Chart.yaml
        run: |
          # Update chart version and app version
          sed -i "s/version: .*/version: ${{ steps.version.outputs.CHART_VERSION }}/" charts/karo/Chart.yaml
          sed -i "s/appVersion: .*/appVersion: \"${{ steps.version.outputs.APP_VERSION }}\"/" charts/karo/Chart.yaml
          
          # Update home and sources URLs to use correct repository
          sed -i "s|home: .*|home: https://github.com/${{ github.repository }}|" charts/karo/Chart.yaml
          sed -i "s|sources:.*|sources:|" charts/karo/Chart.yaml
          sed -i "/sources:/a\\  - https://github.com/${{ github.repository }}" charts/karo/Chart.yaml

      - name: Update values.yaml with correct image
        run: |
          # Update the default image in values.yaml to use Docker Hub
          sed -i "s|repository: .*|repository: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPOSITORY }}/${{ env.IMAGE_NAME }}|" charts/karo/values.yaml
          sed -i "s|tag: .*|tag: \"${{ steps.version.outputs.VERSION }}\"|" charts/karo/values.yaml

      - name: Bundle CRDs with chart
        run: |
          # Create crds directory in chart
          mkdir -p charts/karo/crds/
          
          # Copy CRDs from config/crd to chart crds directory
          cp config/crd/*.yaml charts/karo/crds/
          
          echo "✅ CRDs bundled with chart:"
          ls -la charts/karo/crds/

      - name: Lint Helm chart
        run: |
          helm lint charts/karo/

      - name: Validate Helm chart
        run: |
          # Test template rendering
          helm template test-release charts/karo/ > /tmp/rendered-templates.yaml
          
          # Check if templates are valid YAML
          cat /tmp/rendered-templates.yaml | yq eval '.' > /dev/null
          
          echo "✅ Chart templates are valid"

      - name: Package Helm chart
        run: |
          mkdir -p .helm-charts
          helm package charts/karo/ --destination .helm-charts/
          
          # Create chart index
          helm repo index .helm-charts/ --url https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.RELEASE_TAG }}/

      - name: Push Helm chart to OCI registry
        run: |
          # Push to GitHub Container Registry as OCI artifact
          if [ "${{ steps.version.outputs.IS_MANUAL_DISPATCH }}" = "true" ] && [ "${{ steps.version.outputs.OVERWRITE_ENABLED }}" = "true" ]; then
            echo "Manual dispatch with overwrite enabled - forcing push"
            # Note: Helm doesn't have a --force flag, but we can delete and push
            # This will fail silently if the chart doesn't exist
            helm delete --namespace ghcr oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts/karo:${{ steps.version.outputs.CHART_VERSION }} 2>/dev/null || true
          fi
          
          helm push .helm-charts/karo-${{ steps.version.outputs.CHART_VERSION }}.tgz oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts

      - name: Generate release notes
        id: release_notes
        run: |
          # Create release notes with Helm installation instructions
          cat > release_notes.md << EOF
          ## Helm Chart Release v${{ steps.version.outputs.CHART_VERSION }}
          
          ### Release Notes
          
          ${{ steps.changelog.outputs.RELEASE_NOTES }}
          
          EOF
          
          # Add CHANGELOG section if available
          if [[ -n "${{ steps.changelog.outputs.CHANGELOG_SECTION }}" ]]; then
            echo "" >> release_notes.md
            echo "### Detailed Changes" >> release_notes.md
            echo "" >> release_notes.md
            echo "${{ steps.changelog.outputs.CHANGELOG_SECTION }}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          ### Installation
          
          #### Install from OCI Registry (Recommended)
          \`\`\`bash
          # Install directly from GitHub Container Registry
          helm install karo oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts/karo --version ${{ steps.version.outputs.CHART_VERSION }}
          
          # Or with custom values
          helm install karo oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts/karo --version ${{ steps.version.outputs.CHART_VERSION }} -f values.yaml
          \`\`\`
          
          #### Install from Release Assets
          \`\`\`bash
          # Download and install from release assets
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.RELEASE_TAG }}/karo-${{ steps.version.outputs.CHART_VERSION }}.tgz -o karo-${{ steps.version.outputs.CHART_VERSION }}.tgz
          helm install karo ./karo-${{ steps.version.outputs.CHART_VERSION }}.tgz
          \`\`\`
          
          ### Upgrade
          \`\`\`bash
          # Upgrade from OCI registry
          helm upgrade karo oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts/karo --version ${{ steps.version.outputs.CHART_VERSION }}
          \`\`\`
          
          ### Container Images
          - **Operator Image**: \`${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}\`
          
          ### Chart Details
          - **Chart Version**: ${{ steps.version.outputs.CHART_VERSION }}
          - **App Version**: ${{ steps.version.outputs.APP_VERSION }}
          - **Kubernetes Compatibility**: 1.19+
          
          EOF

      - name: Update GitHub Release with Helm chart info
        if: ${{ steps.version.outputs.IS_MANUAL_DISPATCH != 'true' }}
        run: |
          # Update the existing release with Helm chart information
          RELEASE_TAG="${{ steps.version.outputs.RELEASE_TAG }}"
          
          # Get current release body
          CURRENT_BODY=$(gh release view "$RELEASE_TAG" --json body --jq '.body')
          
          # Append Helm chart information
          echo "$CURRENT_BODY" > current_body.md
          echo "" >> current_body.md
          echo "---" >> current_body.md
          echo "" >> current_body.md
          cat release_notes.md >> current_body.md
          
          # Update the release
          gh release edit "$RELEASE_TAG" \
            --notes-file current_body.md
          
          # Upload Helm chart files to the existing release
          gh release upload "$RELEASE_TAG" \
            .helm-charts/*.tgz \
            .helm-charts/index.yaml \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release for Manual Dispatch
        if: ${{ steps.version.outputs.IS_MANUAL_DISPATCH == 'true' }}
        run: |
          # For manual dispatch, check if release exists and update/create accordingly
          RELEASE_TAG="${{ steps.version.outputs.RELEASE_TAG }}"
          
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Release $RELEASE_TAG exists, uploading Helm chart files"
            # Upload Helm chart files to the existing release
            gh release upload "$RELEASE_TAG" \
              .helm-charts/*.tgz \
              .helm-charts/index.yaml \
              --clobber
          else
            echo "Release $RELEASE_TAG does not exist, creating new release"
            # Create new release with Helm chart info
            gh release create "$RELEASE_TAG" \
              --title "Release $RELEASE_TAG (Manual Helm Chart)" \
              --notes-file release_notes.md \
              --draft \
              .helm-charts/*.tgz \
              .helm-charts/index.yaml
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout gh-pages branch
        if: ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch') && github.event.inputs.skip_gh_pages != 'true' }}
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Helm repository index
        if: ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch') && github.event.inputs.skip_gh_pages != 'true' }}
        run: |
          cd gh-pages-repo
          
          # Configure git identity
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          
          # Clean up any existing content (keep .git and .github)
          find . -maxdepth 1 ! -name '.git*' ! -name '.' -exec rm -rf {} + 2>/dev/null || true
          
          # Copy chart and index
          cp ../.helm-charts/*.tgz .
          cp ../.helm-charts/index.yaml .
          
          # Create simple index.html for the Helm repository
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Karo Helm Repository</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              .code { background: #f4f4f4; padding: 10px; border-radius: 4px; }
            </style>
          </head>
          <body>
            <h1>Karo (Kubernetes Alert Reaction Operator) Helm Repository</h1>
            <p>This is the official Helm repository for Karo.</p>
            
            <h2>Add Repository</h2>
            <div class="code">
              <code>helm repo add karo https://${{ github.repository_owner }}.github.io/karo/</code><br>
              <code>helm repo update</code>
            </div>
            
            <h2>Install Chart</h2>
            <div class="code">
              <code>helm install my-karo karo/karo</code>
            </div>
            
            <h2>Available Charts</h2>
            <ul>
              <li><a href="index.yaml">index.yaml</a> - Helm repository index</li>
          EOF
          
          # Add links to chart packages
          for chart in *.tgz; do
            echo "    <li><a href=\"$chart\">$chart</a></li>" >> index.html
          done
          
          cat >> index.html << 'EOF'
            </ul>
            
            <p>For more information, visit the <a href="https://github.com/${{ github.repository }}">project repository</a>.</p>
          </body>
          </html>
          EOF
          
          # Commit and push
          git add .
          if git commit -m "Update Helm repository for release ${{ steps.version.outputs.RELEASE_TAG }}"; then
            # Push to gh-pages branch (create if it doesn't exist)
            git push origin gh-pages || git push -u origin gh-pages
            echo "✅ Helm repository updated successfully"
          else
            echo "ℹ️ No changes to commit to Helm repository"
          fi

      - name: Summary
        run: |
          echo "## 🎉 Helm Chart Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 Chart Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart Version**: ${{ steps.version.outputs.CHART_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Version**: ${{ steps.version.outputs.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name == 'workflow_dispatch' && 'Manual Dispatch' || 'Automatic Release' }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version.outputs.IS_MANUAL_DISPATCH }}" = "true" ]; then
            echo "- **Overwrite**: ${{ steps.version.outputs.OVERWRITE_ENABLED }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Skip gh-pages**: ${{ github.event.inputs.skip_gh_pages }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **OCI Registry**: \`oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts/karo\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Installation Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# From OCI Registry" >> $GITHUB_STEP_SUMMARY
          echo "helm install karo oci://${{ env.HELM_REGISTRY }}/${{ github.repository_owner }}/charts/karo --version ${{ steps.version.outputs.CHART_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# From Helm Repository" >> $GITHUB_STEP_SUMMARY
          echo "helm repo add karo https://${{ github.repository_owner }}.github.io/karo/" >> $GITHUB_STEP_SUMMARY
          echo "helm install karo karo/karo --version ${{ steps.version.outputs.CHART_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY