#!/bin/bash

# Pre-commit Git hook for the k8s-alert-reaction-operator
# This hook runs formatting, linting, and basic checks before allowing commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ğŸ” Running pre-commit checks...${NC}"

# Check if this is the initial commit
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=$(git hash-object -t tree /dev/null)
fi

# Get list of staged Go files
staged_go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$staged_go_files" ]; then
    echo -e "${YELLOW}â„¹ï¸  No Go files staged for commit${NC}"
    exit 0
fi

echo -e "${GREEN}ğŸ“ Found staged Go files:${NC}"
echo "$staged_go_files"
echo

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to run a command and handle errors
run_check() {
    local cmd="$1"
    local description="$2"
    
    echo -e "${GREEN}ğŸ”„ $description...${NC}"
    
    if eval "$cmd"; then
        echo -e "${GREEN}âœ… $description passed${NC}"
        return 0
    else
        echo -e "${RED}âŒ $description failed${NC}"
        return 1
    fi
}

# Check for required tools
echo -e "${GREEN}ğŸ”§ Checking for required tools...${NC}"

required_tools=("go" "gofmt")
for tool in "${required_tools[@]}"; do
    if ! command_exists "$tool"; then
        echo -e "${RED}âŒ Required tool '$tool' is not installed${NC}"
        exit 1
    fi
done

# Check for golangci-lint (optional but recommended)
if command_exists "golangci-lint"; then
    HAS_GOLANGCI_LINT=true
    echo -e "${GREEN}âœ… golangci-lint found${NC}"
else
    HAS_GOLANGCI_LINT=false
    echo -e "${YELLOW}âš ï¸  golangci-lint not found, skipping advanced linting${NC}"
fi

echo

# 1. Run gofmt to check formatting
echo -e "${GREEN}ğŸ¨ Checking Go formatting...${NC}"
unformatted_files=$(gofmt -l $staged_go_files)
if [ -n "$unformatted_files" ]; then
    echo -e "${RED}âŒ The following files are not properly formatted:${NC}"
    echo "$unformatted_files"
    echo -e "${YELLOW}ğŸ’¡ Run 'gofmt -w <files>' or 'make fmt' to fix formatting${NC}"
    exit 1
else
    echo -e "${GREEN}âœ… All files are properly formatted${NC}"
fi

# 2. Run go vet
if ! run_check "go vet ./..." "Go vet analysis"; then
    echo -e "${YELLOW}ğŸ’¡ Run 'go vet ./...' or 'make vet' to see detailed issues${NC}"
    exit 1
fi

# 3. Run golangci-lint if available
if [ "$HAS_GOLANGCI_LINT" = true ]; then
    if ! run_check "golangci-lint run --timeout=5m" "golangci-lint analysis"; then
        echo -e "${YELLOW}ğŸ’¡ Run 'golangci-lint run' to see detailed issues${NC}"
        exit 1
    fi
fi

# 4. Check if go.mod and go.sum are up to date
echo -e "${GREEN}ğŸ“¦ Checking Go modules...${NC}"
if ! run_check "go mod tidy && git diff --exit-code go.mod go.sum" "Go modules consistency"; then
    echo -e "${YELLOW}ğŸ’¡ Run 'go mod tidy' to fix module dependencies${NC}"
    exit 1
fi

# 5. Build check
if ! run_check "go build ./..." "Go build"; then
    echo -e "${YELLOW}ğŸ’¡ Fix build errors before committing${NC}"
    exit 1
fi

# 6. Quick test run (only for staged files if possible)
echo -e "${GREEN}ğŸ§ª Running quick tests...${NC}"
if ! go test -short ./... >/dev/null 2>&1; then
    echo -e "${YELLOW}âš ï¸  Some tests are failing. Consider running 'make test' before committing.${NC}"
    echo -e "${YELLOW}ğŸ’¡ Continuing with commit, but please address test failures.${NC}"
else
    echo -e "${GREEN}âœ… Quick tests passed${NC}"
fi

echo
echo -e "${GREEN}ğŸ‰ All pre-commit checks passed! Proceeding with commit...${NC}"